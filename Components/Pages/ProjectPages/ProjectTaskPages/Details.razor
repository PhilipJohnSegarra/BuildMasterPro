@page "/projecttasks/details"
@using Microsoft.EntityFrameworkCore
@using BuildMasterPro.Data
@using BuildMasterPro.Services
@using BuildMasterPro.Components.Pages.Dialogs
@inject IDbContextFactory<BuildMasterPro.Data.ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager
@inject ProjectTaskService TaskService
@inject TaskActivityService taskActService
@inject IDialogService DialogService

<MudDialogProvider FullWidth="true" MaxWidth="MaxWidth.Medium"/>
<MudThemeProvider/>

<MudPaper Class="pa-3 SecondaryBG">
    <MudText Class="MainText">@projecttask.TaskName</MudText>
</MudPaper>

@* <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" TabHeaderClass="SecondaryBG" PanelClass="pa-0" Style="min-height:80%;">
    <MudTabPanel Class="MainText" Text="Activities">
        <MudPaper Style="height:80vh;overflow-y:auto;" Elevation="0" Class="pa-6">
            <MudButton OnClick="OpenDialogAsync">Add Activity</MudButton>
            <MudStack>
                @foreach(var act in taskActivities)
                {
                    <MudPaper Class="d-flex flex-column justify-start pa-6" Elevation="1">
                        @if (!string.IsNullOrEmpty(act.Name))
                        {
                            <MudPaper Class="d-flex flex-row justify-space-between align-center" Elevation="0">
                                <MudText Style="font-size:20px;">@act.Name</MudText>
                                <MudText Class="ms-1" Style="color:gray;font-size:10px;">posted by @act.User.Email | @act.DateCreated.Date.ToLongDateString() - @act.DateCreated.ToLocalTime().ToShortTimeString()</MudText>
                            </MudPaper>
                            <MudDivider Class="mb-2 mt-2"/>
                        }
                        <MudText Style="font-size:14px;">@act.Content</MudText>
                    </MudPaper>
                }
            </MudStack>
        </MudPaper>
    </MudTabPanel>
    <MudTabPanel Class="MainText" Text="Files and Links">
        <MudText>Content Two</MudText>
    </MudTabPanel>
    <MudTabPanel Class="MainText" Text="Tab Three">
        <MudText>Content Three</MudText>
    </MudTabPanel>
</MudTabs> *@

<MudGrid>
    <MudItem xs="12" md="12" lg="8" Class="overflow-visible">
        <MudToolBar Class="justify-space-between overflow-visible">
            <MudText Style="font-size:18px;">Activities</MudText>
            <MudFab OnClick="OpenDialogAsync" Class="PrimaryBG MainText customFabButton" StartIcon="@Icons.Material.Filled.Add" Size="Size.Small" />
           @*  <MudIconButton Icon="@Icons.Material.Outlined.Edit" />
            <MudIconButton Icon="@Icons.Material.Outlined.Remove" />
            <MudIconButton Icon="@Icons.Material.Outlined.Notifications" />
            <MudIconButton Icon="@Icons.Material.Outlined.PeopleAlt" />
            <MudIconButton Icon="@Icons.Material.Outlined.MoreVert" Color="Color.Inherit" /> *@
        </MudToolBar>
        
        <MudStack Class="overflow-visible" Style="height:75vh;overflow-y:auto;" Elevation="0">
            @foreach (var act in taskActivities)
            {
                <MudPaper Class="d-flex flex-column justify-start pa-6" Elevation="0">
                    @if (!string.IsNullOrEmpty(act.Name))
                    {
                        <MudPaper Class="d-flex flex-row justify-space-between align-center" Elevation="0">
                            <MudText Style="font-size:20px;">@act.Name</MudText>
                            <MudText Class="ms-1" Style="color:gray;font-size:13px;">posted by @act.User.Email | @act.DateCreated.Date.ToLongDateString() - @act.DateCreated.ToLocalTime().ToShortTimeString()</MudText>
                        </MudPaper>
                        <MudDivider Class="mb-2 mt-2" />
                    }
                    <MudText Style="font-size:14px;">@act.Content</MudText>
                </MudPaper>
            }
        </MudStack>
    </MudItem>
    <MudItem xs="12" md="12" lg="4" Style="height:100%;">
        <MudPaper xs="12" md="12" lg="12">
            <MudItem xs="12" md="12" lg="12">
                <MudPaper>

                </MudPaper>
            </MudItem>
            <MudItem xs="12" md="12" lg="12">
                <MudPaper Height="50%">

                </MudPaper>
            </MudItem>
        </MudPaper>
        
    </MudItem>
</MudGrid>
<style>
    .customFabButton:hover{
        background-color: #FFA800;
    }
</style>

@code {
    private ProjectTask? projecttask { get; set; } = new();

    [SupplyParameterFromQuery]
    private int TaskId { get; set; }

    private List<TaskActivity> taskActivities { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        projecttask = await context.ProjectTask.FirstOrDefaultAsync(m => m.TaskId == TaskId);
        taskActivities = await taskActService.GetByTask(projecttask);

        if (projecttask is null)
        {
            NavigationManager.NavigateTo("notfound");
        }
    }
    private async Task OpenDialogAsync()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };

        var parameters = new DialogParameters<TaskActivityAdderDialog>
        {
            {x => x.TaskID, projecttask.TaskId}
        };

        var result = await DialogService.ShowAsync<TaskActivityAdderDialog>("Simple Dialog",parameters, options);

    }
}
